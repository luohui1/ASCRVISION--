<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>批量检测 - ACSR VISION</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
    --void:#030303;--obsidian:#0a0a0a;--carbon:#111;--graphite:#1a1a1a;--steel:#2a2a2a;
    --gold:#d4af37;--gold-bright:#f4d03f;--gold-dim:rgba(212,175,55,0.12);--gold-glow:rgba(212,175,55,0.4);
    --ivory:#f8f6f0;--silver:#888;--success:#00ff88;--danger:#ff4757;
    --scan-line:rgba(212,175,55,0.03);
}
html{font-size:16px}
body{font-family:'Rajdhani',sans-serif;background:var(--void);color:var(--ivory);min-height:100vh;overflow-x:hidden;position:relative}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,var(--scan-line) 0px,var(--scan-line) 1px,transparent 1px,transparent 3px),radial-gradient(ellipse at 50% 0%,rgba(212,175,55,0.08) 0%,transparent 60%);pointer-events:none;z-index:0}

nav{position:fixed;top:0;left:0;right:0;z-index:1000;background:linear-gradient(180deg,rgba(3,3,3,0.98) 0%,rgba(3,3,3,0.9) 100%);backdrop-filter:blur(20px);border-bottom:1px solid rgba(212,175,55,0.15);padding:0 40px;height:64px;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:14px;text-decoration:none}
.logo-icon{width:42px;height:42px;border:1.5px solid var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center;position:relative;transition:all 0.4s cubic-bezier(0.4,0,0.2,1)}
.logo-icon::before{content:'';position:absolute;inset:3px;border:1px solid rgba(212,175,55,0.3);border-radius:50%}
.logo-icon svg{width:18px;height:18px;color:var(--gold)}
.logo:hover .logo-icon{transform:rotate(180deg);box-shadow:0 0 20px var(--gold-glow)}
.logo-text{font-family:'Orbitron',monospace;font-size:1.1rem;font-weight:600;letter-spacing:3px;color:var(--ivory)}
.logo-text span{color:var(--gold)}
.nav-links{display:flex;gap:6px}
.nav-link{font-family:'Orbitron',monospace;padding:10px 20px;font-size:0.7rem;letter-spacing:2px;text-transform:uppercase;text-decoration:none;color:var(--silver);border:1px solid transparent;position:relative;transition:all 0.3s}
.nav-link::before{content:'';position:absolute;bottom:0;left:50%;width:0;height:1px;background:var(--gold);transition:all 0.3s;transform:translateX(-50%)}
.nav-link:hover,.nav-link.active{color:var(--gold)}
.nav-link:hover::before,.nav-link.active::before{width:60%}
.nav-link.active{border-color:rgba(212,175,55,0.2);background:var(--gold-dim)}

.hero-title{padding:100px 40px 20px;text-align:center;position:relative;z-index:1}
.title-en{font-family:'Orbitron',monospace;font-size:3.5rem;font-weight:700;letter-spacing:12px;color:var(--ivory);text-shadow:0 0 60px rgba(212,175,55,0.3);margin-bottom:8px;background:linear-gradient(135deg,var(--ivory) 0%,var(--gold) 50%,var(--ivory) 100%);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:shimmer 4s linear infinite}
.title-en span{background:linear-gradient(135deg,var(--gold) 0%,var(--gold-bright) 50%,var(--gold) 100%);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
@keyframes shimmer{to{background-position:200% center}}
.title-cn{font-family:'Rajdhani','Microsoft YaHei',sans-serif;font-size:1.1rem;font-weight:400;letter-spacing:8px;color:var(--silver);text-transform:uppercase}
.title-line{width:120px;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);margin:16px auto 0}

.main{padding:20px 40px 40px;max-width:1400px;margin:0 auto;position:relative;z-index:1}
@media(max-width:768px){.main{padding:20px}}

.panel{background:linear-gradient(145deg,var(--obsidian) 0%,var(--carbon) 100%);border:1px solid rgba(212,175,55,0.12);position:relative;margin-bottom:24px}
.panel::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--gold),transparent);opacity:0.5}
.panel-corner{position:absolute;width:20px;height:20px;border-color:var(--gold);border-style:solid;border-width:0;opacity:0.6}
.panel-corner.tl{top:-1px;left:-1px;border-top-width:2px;border-left-width:2px}
.panel-corner.tr{top:-1px;right:-1px;border-top-width:2px;border-right-width:2px}
.panel-corner.bl{bottom:-1px;left:-1px;border-bottom-width:2px;border-left-width:2px}
.panel-corner.br{bottom:-1px;right:-1px;border-bottom-width:2px;border-right-width:2px}
.panel-header{padding:20px 24px;border-bottom:1px solid rgba(212,175,55,0.1);display:flex;align-items:center;justify-content:space-between}
.panel-title{font-family:'Orbitron',monospace;font-size:0.8rem;font-weight:500;letter-spacing:3px;text-transform:uppercase;color:var(--gold);display:flex;align-items:center;gap:12px}
.panel-title svg{width:18px;height:18px;opacity:0.8}
.panel-badge{font-family:'Orbitron',monospace;padding:5px 12px;background:var(--gold-dim);border:1px solid rgba(212,175,55,0.2);color:var(--gold);font-size:0.6rem;letter-spacing:2px}
.panel-body{padding:24px}

.upload-zone{border:1px dashed rgba(212,175,55,0.25);background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(212,175,55,0.02) 10px,rgba(212,175,55,0.02) 20px);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.4s;position:relative;min-height:200px;overflow:hidden}
.upload-zone::before{content:'';position:absolute;inset:0;background:radial-gradient(circle at center,var(--gold-dim) 0%,transparent 70%);opacity:0;transition:opacity 0.4s}
.upload-zone:hover::before,.upload-zone.active::before{opacity:1}
.upload-zone:hover,.upload-zone.active{border-color:var(--gold);border-style:solid}
.upload-content{text-align:center;padding:40px;position:relative;z-index:1}
.upload-icon{width:70px;height:70px;margin:0 auto 20px;border:2px solid rgba(212,175,55,0.3);position:relative;display:flex;align-items:center;justify-content:center;transition:all 0.4s}
.upload-icon::before,.upload-icon::after{content:'';position:absolute;border:1px solid rgba(212,175,55,0.15)}
.upload-icon::before{inset:5px}
.upload-icon::after{inset:10px}
.upload-zone:hover .upload-icon{border-color:var(--gold);transform:scale(1.05);box-shadow:0 0 40px var(--gold-dim)}
.upload-icon svg{width:24px;height:24px;color:var(--gold)}
.upload-title{font-family:'Orbitron',monospace;font-size:0.9rem;font-weight:500;letter-spacing:2px;margin-bottom:8px}
.upload-hint{font-size:0.85rem;color:var(--silver)}

.file-list{margin-top:20px;max-height:180px;overflow-y:auto}
.file-item{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(212,175,55,0.05);border-left:2px solid var(--gold);margin-bottom:8px}
.file-name{font-size:0.85rem;display:flex;align-items:center;gap:10px}
.file-name svg{width:16px;height:16px;color:var(--gold);opacity:0.6}
.file-remove{background:none;border:none;color:var(--danger);cursor:pointer;font-size:1.4rem;line-height:1;opacity:0.7;transition:opacity 0.3s}
.file-remove:hover{opacity:1}

.actions{display:flex;gap:12px;margin-top:20px}
.btn{flex:1;font-family:'Orbitron',monospace;padding:16px 24px;font-size:0.75rem;font-weight:500;letter-spacing:2px;text-transform:uppercase;border:none;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden}
.btn svg{width:16px;height:16px}
.btn-primary{background:linear-gradient(135deg,var(--gold) 0%,#c9a227 100%);color:var(--void)}
.btn-primary::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,var(--gold-bright) 0%,var(--gold) 100%);opacity:0;transition:opacity 0.3s}
.btn-primary:hover::before{opacity:1}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(212,175,55,0.3)}
.btn-primary:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}
.btn-primary span,.btn-primary svg{position:relative;z-index:1}
.btn-ghost{background:transparent;border:1px solid rgba(212,175,55,0.3);color:var(--gold)}
.btn-ghost:hover{background:var(--gold-dim);border-color:var(--gold)}

.progress-section{display:none;margin-bottom:24px}
.progress-section.show{display:block}
.progress-wrap{padding:24px;background:linear-gradient(145deg,var(--obsidian) 0%,var(--carbon) 100%);border:1px solid rgba(212,175,55,0.12)}
.progress-bar{height:4px;background:rgba(255,255,255,0.1);position:relative;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--gold-bright));width:0;transition:width 0.3s}
.progress-text{font-family:'Orbitron',monospace;font-size:0.75rem;color:var(--silver);margin-top:12px;letter-spacing:1px;display:flex;align-items:center;gap:10px}
.progress-text::before{content:'';width:8px;height:8px;background:var(--gold);animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:0.3}50%{opacity:1}}

.results-section{display:none}
.results-section.show{display:block}
.results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:16px 20px;background:var(--obsidian);border:1px solid rgba(212,175,55,0.1)}
.results-title{font-family:'Orbitron',monospace;font-size:0.85rem;font-weight:500;letter-spacing:2px;color:var(--gold)}
.results-stats{display:flex;gap:20px}
.stat{font-family:'Orbitron',monospace;font-size:0.75rem;letter-spacing:1px;display:flex;align-items:center;gap:8px}
.stat::before{content:'';width:8px;height:8px}
.stat-pass{color:var(--success)}
.stat-pass::before{background:var(--success)}
.stat-fail{color:var(--danger)}
.stat-fail::before{background:var(--danger)}

.results-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
.result-card{background:linear-gradient(145deg,var(--obsidian) 0%,var(--carbon) 100%);border:1px solid rgba(212,175,55,0.12);overflow:hidden;transition:all 0.3s}
.result-card:hover{border-color:var(--gold);transform:translateY(-4px);box-shadow:0 20px 40px rgba(0,0,0,0.4)}
.result-image{width:100%;height:200px;object-fit:cover;background:var(--void);border-bottom:1px solid rgba(212,175,55,0.1)}
.result-info{padding:16px}
.result-filename{font-size:0.85rem;font-weight:600;margin-bottom:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.result-status{display:inline-block;padding:5px 12px;font-family:'Orbitron',monospace;font-size:0.65rem;font-weight:600;letter-spacing:1px}
.result-status.pass{background:rgba(0,255,136,0.1);border:1px solid rgba(0,255,136,0.3);color:var(--success)}
.result-status.fail{background:rgba(255,71,87,0.1);border:1px solid rgba(255,71,87,0.3);color:var(--danger)}
.result-defects{font-size:0.8rem;color:var(--silver);margin-top:10px}
.result-actions{display:flex;gap:8px;margin-top:14px}
.result-btn{flex:1;padding:10px;background:transparent;border:1px solid rgba(212,175,55,0.2);color:var(--gold);font-family:'Orbitron',monospace;font-size:0.6rem;letter-spacing:1px;cursor:pointer;transition:all 0.3s}
.result-btn:hover{background:var(--gold);color:var(--void)}

input[type="file"]{display:none}
    </style>
</head>
<body>
<nav>
    <a href="/" class="logo">
        <div class="logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3"/><path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"/></svg></div>
        <div class="logo-text">ACSR<span>VISION</span></div>
    </a>
    <div class="nav-links">
        <a href="/detect" class="nav-link">单张检测</a>
        <a href="/batch" class="nav-link active">批量检测</a>
        <a href="/3d" class="nav-link">3D展示</a>
        <a href="/" class="nav-link">首页</a>
    </div>
</nav>

<div class="hero-title">
    <div class="title-en">ACSR<span>VISION</span></div>
    <div class="title-cn">钢芯铝绞线智能质检系统</div>
    <div class="title-line"></div>
</div>

<main class="main">
    <div class="panel">
        <div class="panel-corner tl"></div>
        <div class="panel-corner tr"></div>
        <div class="panel-corner bl"></div>
        <div class="panel-corner br"></div>
        <div class="panel-header">
            <div class="panel-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                批量图像上传
            </div>
            <span class="panel-badge">BATCH MODE</span>
        </div>
        <div class="panel-body">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-content">
                    <div class="upload-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    </div>
                    <div class="upload-title">拖放多张图片到此处</div>
                    <div class="upload-hint">或点击选择文件，支持 JPG / PNG / WEBP 格式</div>
                </div>
            </div>
            <input type="file" id="fileInput" accept="image/*" multiple>
            <div class="file-list" id="fileList"></div>
            <div class="actions">
                <button class="btn btn-primary" id="detectBtn" disabled onclick="startBatchDetect()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                    <span>开始批量检测</span>
                </button>
                <button class="btn btn-ghost" onclick="clearFiles()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                    <span>清空列表</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="progress-section" id="progressSection">
        <div class="progress-wrap">
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
            <div class="progress-text" id="progressText">正在检测...</div>
        </div>
    </div>
    
    <div class="results-section" id="resultsSection">
        <div class="results-header">
            <div class="results-title">检测结果</div>
            <div class="results-stats">
                <span class="stat stat-pass" id="passCount">合格: 0</span>
                <span class="stat stat-fail" id="failCount">不合格: 0</span>
            </div>
        </div>
        <div class="results-grid" id="resultsGrid"></div>
    </div>
</main>

<script>
let files = [];
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const detectBtn = document.getElementById('detectBtn');

uploadZone.addEventListener('click', () => fileInput.click());
uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('active'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('active'));
uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('active'); addFiles(e.dataTransfer.files); });
fileInput.addEventListener('change', e => addFiles(e.target.files));

function addFiles(newFiles) {
    for (let f of newFiles) {
        if (f.type.startsWith('image/') && !files.find(x => x.name === f.name)) files.push(f);
    }
    renderFileList();
}

function renderFileList() {
    fileList.innerHTML = files.map((f, i) => `
        <div class="file-item">
            <span class="file-name"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>${f.name}</span>
            <button class="file-remove" onclick="removeFile(${i})">&times;</button>
        </div>
    `).join('');
    detectBtn.disabled = files.length === 0;
}

function removeFile(i) { files.splice(i, 1); renderFileList(); }
function clearFiles() { files = []; renderFileList(); document.getElementById('resultsSection').classList.remove('show'); }

async function startBatchDetect() {
    if (files.length === 0) return;
    detectBtn.disabled = true;
    document.getElementById('progressSection').classList.add('show');
    document.getElementById('resultsSection').classList.remove('show');
    const formData = new FormData();
    files.forEach(f => formData.append('images', f));
    document.getElementById('progressFill').style.width = '30%';
    document.getElementById('progressText').textContent = `正在检测 ${files.length} 张图片...`;
    try {
        const res = await fetch('/batch/detect', { method: 'POST', body: formData });
        const data = await res.json();
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressText').textContent = '检测完成!';
        setTimeout(() => { document.getElementById('progressSection').classList.remove('show'); showResults(data.results); }, 500);
    } catch (err) { alert('检测失败: ' + err.message); }
    detectBtn.disabled = false;
}

function showResults(results) {
    const passCount = results.filter(r => r.conclusion === '合格').length;
    document.getElementById('passCount').textContent = `合格: ${passCount}`;
    document.getElementById('failCount').textContent = `不合格: ${results.length - passCount}`;
    document.getElementById('resultsGrid').innerHTML = results.map(r => `
        <div class="result-card">
            <img src="${r.result_image}" class="result-image" alt="${r.filename}">
            <div class="result-info">
                <div class="result-filename">${r.filename}</div>
                <span class="result-status ${r.conclusion === '合格' ? 'pass' : 'fail'}">${r.conclusion}</span>
                <div class="result-defects">${r.detections.length > 0 ? r.detections.map(d => d.class_name).join(', ') : '无缺陷'}</div>
                <div class="result-actions">
                    <button class="result-btn" onclick="window.open('${r.result_image}','_blank')">查看大图</button>
                    <button class="result-btn" onclick="genReport('${encodeURIComponent(JSON.stringify(r))}')">生成报告</button>
                </div>
            </div>
        </div>
    `).join('');
    document.getElementById('resultsSection').classList.add('show');
}

async function genReport(dataStr) {
    const data = JSON.parse(decodeURIComponent(dataStr));
    try {
        const res = await fetch('/report/pdf', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ detections: data.detections, result_image: data.result_image }) });
        const r = await res.json();
        if (r.success) window.open(r.url, '_blank'); else alert('报告生成失败');
    } catch (e) { alert('报告生成失败: ' + e.message); }
}
</script>
</body>
</html>
