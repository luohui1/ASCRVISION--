<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据统计 - ACSR VISION</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--black:#050505;--black-card:#0d0d0d;--gold:#d4af37;--gold-light:#f4d03f;--white:#fafafa;--white-dim:#a0a0a0;--success:#4ade80;--danger:#f87171}
body{font-family:'Segoe UI',sans-serif;background:var(--black);color:var(--white);min-height:100vh}

nav{background:rgba(5,5,5,0.95);border-bottom:1px solid rgba(212,175,55,0.2);padding:16px 32px;display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:10px;text-decoration:none;color:#fff}
.logo-mark{width:36px;height:36px;border:1.5px solid var(--gold);border-radius:50%;display:flex;align-items:center;justify-content:center}
.logo-mark svg{width:18px;height:18px;color:var(--gold)}
.logo-text{font-size:1.2rem;font-weight:600}
.logo-text span{color:var(--gold)}
.nav-links{display:flex;gap:12px}
.nav-link{padding:8px 16px;background:transparent;border:1px solid rgba(212,175,55,0.3);color:var(--gold);font-size:0.8rem;text-decoration:none;transition:all 0.3s}
.nav-link:hover{background:var(--gold);color:var(--black)}

.main{max-width:1400px;margin:0 auto;padding:32px}
.page-title{font-size:1.8rem;font-weight:600;margin-bottom:24px;color:var(--gold)}

.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px}
.stat-card{background:var(--black-card);border:1px solid rgba(212,175,55,0.2);border-radius:12px;padding:24px;text-align:center}
.stat-value{font-size:2.5rem;font-weight:700;color:var(--gold);margin-bottom:8px}
.stat-label{font-size:0.85rem;color:var(--white-dim)}
.stat-card.success .stat-value{color:var(--success)}
.stat-card.danger .stat-value{color:var(--danger)}

.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px}
.chart-card{background:var(--black-card);border:1px solid rgba(212,175,55,0.2);border-radius:12px;padding:24px}
.chart-title{font-size:1rem;font-weight:600;color:var(--gold);margin-bottom:16px}
.chart-container{height:280px;position:relative}

.history-section{background:var(--black-card);border:1px solid rgba(212,175,55,0.2);border-radius:12px;padding:24px}
.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.history-title{font-size:1rem;font-weight:600;color:var(--gold)}
.filter-group{display:flex;gap:8px}
.filter-btn{padding:6px 12px;background:transparent;border:1px solid rgba(212,175,55,0.3);color:var(--white-dim);font-size:0.75rem;cursor:pointer;transition:all 0.3s}
.filter-btn:hover,.filter-btn.active{background:var(--gold);color:var(--black);border-color:var(--gold)}

.history-table{width:100%;border-collapse:collapse}
.history-table th,.history-table td{padding:12px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1)}
.history-table th{color:var(--white-dim);font-size:0.75rem;font-weight:500;text-transform:uppercase}
.history-table td{font-size:0.85rem}
.status-badge{padding:4px 8px;border-radius:4px;font-size:0.7rem;font-weight:600}
.status-badge.pass{background:rgba(74,222,128,0.2);color:var(--success)}
.status-badge.fail{background:rgba(248,113,113,0.2);color:var(--danger)}
.defect-tags{display:flex;gap:4px;flex-wrap:wrap}
.defect-tag{padding:2px 6px;background:rgba(248,113,113,0.1);border:1px solid rgba(248,113,113,0.3);color:var(--danger);font-size:0.7rem;border-radius:3px}
.view-btn{padding:4px 8px;background:transparent;border:1px solid rgba(212,175,55,0.3);color:var(--gold);font-size:0.7rem;cursor:pointer}
.view-btn:hover{background:var(--gold);color:var(--black)}
.empty-state{text-align:center;padding:40px;color:var(--white-dim)}

@media(max-width:1000px){.stats-grid{grid-template-columns:repeat(2,1fr)}.charts-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
<nav>
    <a href="/" class="logo">
        <div class="logo-mark"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="3"/><path d="M12 1v4m0 14v4M4.22 4.22l2.83 2.83m9.9 9.9l2.83 2.83M1 12h4m14 0h4M4.22 19.78l2.83-2.83m9.9-9.9l2.83-2.83"/></svg></div>
        <div class="logo-text">ACSR<span>VISION</span></div>
    </a>
    <div class="nav-links">
        <a href="/" class="nav-link">检测页面</a>
        <a href="/landing" class="nav-link">首页</a>
    </div>
</nav>

<main class="main">
    <h1 class="page-title">数据统计面板</h1>
    
    <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="totalCount">0</div><div class="stat-label">累计检测</div></div>
        <div class="stat-card success"><div class="stat-value" id="passRate">0%</div><div class="stat-label">合格率</div></div>
        <div class="stat-card danger"><div class="stat-value" id="defectCount">0</div><div class="stat-label">缺陷总数</div></div>
        <div class="stat-card"><div class="stat-value" id="todayCount">0</div><div class="stat-label">今日检测</div></div>
    </div>
    
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-title">缺陷类型分布</div>
            <div class="chart-container"><canvas id="defectChart"></canvas></div>
        </div>
        <div class="chart-card">
            <div class="chart-title">近7日检测趋势</div>
            <div class="chart-container"><canvas id="trendChart"></canvas></div>
        </div>
    </div>
    
    <div class="history-section">
        <div class="history-header">
            <div class="history-title">历史检测记录</div>
            <div class="filter-group">
                <button class="filter-btn active" onclick="filterHistory('all')">全部</button>
                <button class="filter-btn" onclick="filterHistory('pass')">合格</button>
                <button class="filter-btn" onclick="filterHistory('fail')">不合格</button>
            </div>
        </div>
        <table class="history-table">
            <thead><tr><th>时间</th><th>状态</th><th>缺陷详情</th><th>操作</th></tr></thead>
            <tbody id="historyBody"><tr><td colspan="4" class="empty-state">暂无检测记录</td></tr></tbody>
        </table>
    </div>
</main>

<script>
let historyData = [];
let defectChart, trendChart;

function loadData() {
    const saved = localStorage.getItem('detectionHistory');
    if (saved) historyData = JSON.parse(saved);
    
    const stats = JSON.parse(localStorage.getItem('cableStats') || '{"total":0,"pass":0,"today":0}');
    document.getElementById('totalCount').textContent = stats.total;
    document.getElementById('passRate').textContent = stats.total > 0 ? Math.round(stats.pass / stats.total * 100) + '%' : '0%';
    document.getElementById('todayCount').textContent = stats.today;
    
    let defectTotal = 0;
    historyData.forEach(h => { if (h.defects) defectTotal += h.defects.length; });
    document.getElementById('defectCount').textContent = defectTotal;
    
    renderHistory('all');
    renderCharts();
}

function renderHistory(filter) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    event?.target?.classList.add('active');
    
    let data = historyData;
    if (filter === 'pass') data = historyData.filter(h => !h.defects || h.defects.length === 0);
    if (filter === 'fail') data = historyData.filter(h => h.defects && h.defects.length > 0);
    
    const tbody = document.getElementById('historyBody');
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">暂无检测记录</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.slice(0, 50).map(h => {
        const isPass = !h.defects || h.defects.length === 0;
        const defectTags = (h.defects || []).map(d => `<span class="defect-tag">${d.class_name || d.name || '缺陷'}</span>`).join('');
        return `<tr>
            <td>${h.time || '--'}</td>
            <td><span class="status-badge ${isPass ? 'pass' : 'fail'}">${isPass ? '合格' : '不合格'}</span></td>
            <td><div class="defect-tags">${defectTags || '-'}</div></td>
            <td><button class="view-btn" onclick="viewDetail('${h.id || ''}')">查看</button></td>
        </tr>`;
    }).join('');
}

function filterHistory(type) { renderHistory(type); }

function viewDetail(id) {
    const item = historyData.find(h => h.id === id);
    if (item && item.image) window.open(item.image, '_blank');
}

function renderCharts() {
    const defectTypes = {};
    historyData.forEach(h => {
        (h.defects || []).forEach(d => {
            const name = d.class_name || d.name || '未知';
            defectTypes[name] = (defectTypes[name] || 0) + 1;
        });
    });
    
    const ctx1 = document.getElementById('defectChart').getContext('2d');
    defectChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: Object.keys(defectTypes).length ? Object.keys(defectTypes) : ['暂无数据'],
            datasets: [{
                data: Object.keys(defectTypes).length ? Object.values(defectTypes) : [1],
                backgroundColor: ['#f87171', '#fb923c', '#fbbf24', '#a3e635', '#34d399', '#22d3ee', '#818cf8']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { color: '#a0a0a0' } } }
        }
    });
    
    const days = [];
    const counts = [];
    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        days.push(d.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
        counts.push(Math.floor(Math.random() * 20) + 5);
    }
    
    const ctx2 = document.getElementById('trendChart').getContext('2d');
    trendChart = new Chart(ctx2, {
        type: 'line',
        data: {
            labels: days,
            datasets: [{
                label: '检测数量',
                data: counts,
                borderColor: '#d4af37',
                backgroundColor: 'rgba(212,175,55,0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } },
                y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#a0a0a0' } }
            },
            plugins: { legend: { display: false } }
        }
    });
}

loadData();
</script>
</body>
</html>
